name: Build and Deploy to Azure Container Apps

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'prod'
        type: choice
        options:
          - dev
          - staging
          - prod
      deploy_infrastructure:
        description: 'Deploy/update infrastructure'
        required: true
        default: false
        type: boolean

env:
  APP_NAME: bgg-gg
  AZURE_LOCATION: australiaeast

jobs:
  # Phase 1: Deploy infrastructure (ACR, Container Apps Environment)
  deploy-infrastructure:
    name: Deploy Infrastructure
    runs-on: ubuntu-latest
    if: github.event.inputs.deploy_infrastructure == 'true'
    environment: ${{ github.event.inputs.environment || 'prod' }}
    
    outputs:
      acr_login_server: ${{ steps.deploy.outputs.containerRegistryLoginServer }}
      acr_name: ${{ steps.deploy.outputs.containerRegistryName }}
      resource_group: ${{ steps.deploy.outputs.resourceGroupName }}
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Login to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy Bicep template (infrastructure only)
        id: deploy
        uses: azure/arm-deploy@v2
        with:
          scope: subscription
          subscriptionId: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          region: ${{ env.AZURE_LOCATION }}
          template: ./infra/main.bicep
          parameters: >
            appName=${{ env.APP_NAME }}
            location=${{ env.AZURE_LOCATION }}
            environment=${{ github.event.inputs.environment || 'prod' }}
            deployContainerApps=false
          failOnStdErr: false

      - name: Output infrastructure info
        run: |
          echo "### Infrastructure Deployed :building_construction:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Resource | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Resource Group | ${{ steps.deploy.outputs.resourceGroupName }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Container Registry | ${{ steps.deploy.outputs.containerRegistryLoginServer }} |" >> $GITHUB_STEP_SUMMARY

  # Phase 2: Build and push container images
  build:
    name: Build Container Images
    runs-on: ubuntu-latest
    needs: [deploy-infrastructure]
    # Run if infrastructure was deployed, OR if this is a regular push/PR (infrastructure already exists)
    if: always() && (needs.deploy-infrastructure.result == 'success' || needs.deploy-infrastructure.result == 'skipped')
    
    outputs:
      image_tag: ${{ steps.meta.outputs.version }}
      acr_login_server: ${{ steps.acr.outputs.acr_login_server }}
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Generate image metadata
        id: meta
        run: |
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          echo "version=${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "Image tag: ${SHORT_SHA}"

      - name: Login to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Get ACR credentials
        id: acr
        run: |
          ENVIRONMENT="${{ github.event.inputs.environment || 'prod' }}"
          RESOURCE_GROUP="rg-${{ env.APP_NAME }}-${ENVIRONMENT}"
          
          # Check if resource group exists
          if ! az group exists -n $RESOURCE_GROUP | grep -q true; then
            echo "Resource group $RESOURCE_GROUP does not exist. Run with deploy_infrastructure=true first."
            echo "acr_exists=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          ACR_NAME=$(az acr list -g $RESOURCE_GROUP --query "[0].name" -o tsv 2>/dev/null || echo "")
          
          if [ -z "$ACR_NAME" ]; then
            echo "ACR not found in $RESOURCE_GROUP. Run with deploy_infrastructure=true first."
            echo "acr_exists=false" >> $GITHUB_OUTPUT
          else
            ACR_LOGIN_SERVER=$(az acr show -n $ACR_NAME --query "loginServer" -o tsv)
            echo "acr_exists=true" >> $GITHUB_OUTPUT
            echo "acr_name=$ACR_NAME" >> $GITHUB_OUTPUT
            echo "acr_login_server=$ACR_LOGIN_SERVER" >> $GITHUB_OUTPUT
            echo "Found ACR: $ACR_LOGIN_SERVER"
          fi

      - name: Login to ACR
        if: steps.acr.outputs.acr_exists == 'true'
        run: |
          az acr login --name ${{ steps.acr.outputs.acr_name }}

      - name: Build and push backend image
        if: steps.acr.outputs.acr_exists == 'true'
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: true
          tags: |
            ${{ steps.acr.outputs.acr_login_server }}/${{ env.APP_NAME }}-backend:${{ steps.meta.outputs.version }}
            ${{ steps.acr.outputs.acr_login_server }}/${{ env.APP_NAME }}-backend:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push frontend image
        if: steps.acr.outputs.acr_exists == 'true'
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          push: true
          tags: |
            ${{ steps.acr.outputs.acr_login_server }}/${{ env.APP_NAME }}-frontend:${{ steps.meta.outputs.version }}
            ${{ steps.acr.outputs.acr_login_server }}/${{ env.APP_NAME }}-frontend:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # Phase 3: Deploy Container Apps (after images exist)
  deploy-apps:
    name: Deploy Container Apps
    runs-on: ubuntu-latest
    needs: [build]
    if: always() && needs.build.result == 'success'
    environment: ${{ github.event.inputs.environment || 'prod' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Login to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy Container Apps via Bicep
        id: deploy
        uses: azure/arm-deploy@v2
        with:
          scope: subscription
          subscriptionId: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          region: ${{ env.AZURE_LOCATION }}
          template: ./infra/main.bicep
          parameters: >
            appName=${{ env.APP_NAME }}
            location=${{ env.AZURE_LOCATION }}
            environment=${{ github.event.inputs.environment || 'prod' }}
            imageTag=${{ needs.build.outputs.image_tag }}
            deployContainerApps=true
            bggAccessToken=${{ secrets.BGG_ACCESS_TOKEN }}
          failOnStdErr: false

      - name: Output deployment info
        run: |
          echo "### Deployment Complete! :rocket:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Resource | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend URL | ${{ steps.deploy.outputs.frontendUrl }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Image Tag | ${{ needs.build.outputs.image_tag }} |" >> $GITHUB_STEP_SUMMARY
